#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Route cache generator for LeanPHP
 *
 * This script compiles all routes to storage/cache/routes.php for improved performance in production.
 */

// Load Composer autoloader
require_once __DIR__ . '/../vendor/autoload.php';

use LeanPHP\Routing\Router;

// Load environment variables if .env file exists
if (file_exists(__DIR__ . '/../.env')) {
    $dotenv = Dotenv\Dotenv::createImmutable(__DIR__ . '/..');
    $dotenv->load();
}

// Create router and register routes (same as in index.php)
$router = new Router();
require __DIR__ . '/../routes/api.php';

// Get the compiled route data from the router
$compiledRoutes = $router->getCompiledRoutes();

// Filter out routes with closure handlers (not suitable for caching)
$cacheableRoutes = [];
$skippedRoutes = 0;

foreach ($compiledRoutes as $route) {
    if (is_callable($route['handler']) && !is_array($route['handler'])) {
        // Skip closure handlers - they can't be cached
        $skippedRoutes++;
        echo "Warning: Skipping route {$route['method']} {$route['path']} - closure handlers cannot be cached\n";
        continue;
    }

    $cacheableRoutes[] = $route;
}

if ($skippedRoutes > 0) {
    echo "Note: {$skippedRoutes} routes with closure handlers were skipped. Use controller handlers for caching.\n\n";
}

// Ensure cache directory exists
$cacheDir = __DIR__ . '/../storage/cache';
if (!is_dir($cacheDir)) {
    mkdir($cacheDir, 0755, true);
}

// Generate the cache file content
$cacheContent = "<?php\n\n";
$cacheContent .= "declare(strict_types=1);\n\n";
$cacheContent .= "/**\n";
$cacheContent .= " * Compiled route cache for LeanPHP\n";
$cacheContent .= " * Generated at: " . date('Y-m-d H:i:s T') . "\n";
$cacheContent .= " * \n";
$cacheContent .= " * DO NOT EDIT THIS FILE DIRECTLY - it will be overwritten\n";
$cacheContent .= " * Use 'php bin/route_cache.php' to regenerate\n";
$cacheContent .= " */\n\n";
$cacheContent .= "return " . var_export($cacheableRoutes, true) . ";\n";

// Write the cache file
$cacheFile = $cacheDir . '/routes.php';
$result = file_put_contents($cacheFile, $cacheContent);

if ($result === false) {
    echo "Error: Failed to write route cache to {$cacheFile}\n";
    exit(1);
}

echo "Route cache generated successfully at {$cacheFile}\n";
echo "Cached " . count($cacheableRoutes) . " routes (skipped {$skippedRoutes} closure handlers)\n";
echo "Cache size: " . number_format(filesize($cacheFile)) . " bytes\n";
